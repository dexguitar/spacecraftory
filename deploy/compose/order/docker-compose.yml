services: # Section describing the containers required for the Order service
  postgres-order: # PostgreSQL container used for storing order data
    image: postgres:17.0-alpine3.20
    # Using official PostgreSQL version 17 image based on Alpine Linux
    # This is a lightweight and fast build that saves resources

    container_name: postgres-order
    # Setting a unique container name for convenient access in CLI and debugging

    env_file:
      - .env

    environment:
      - POSTGRES_USER=${ORDER_POSTGRES_USER}
      - POSTGRES_PASSWORD=${ORDER_POSTGRES_PASSWORD}
      - POSTGRES_DB=${ORDER_POSTGRES_DB}

    volumes:
      - postgres_order_data:/var/lib/postgresql/data
      # Define the volume to be used for storing PostgreSQL data
      # It preserves data between container restarts

    ports:
      - "${ORDER_EXTERNAL_POSTGRES_PORT}:${ORDER_POSTGRES_PORT}"
      # Expose PostgreSQL's internal port to the host port
      # This allows other services or tools to connect to the database

    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${ORDER_POSTGRES_USER} -d ${ORDER_POSTGRES_DB}"]
      # Configure container readiness check — pg_isready checks if the database is accepting connections
      interval: 10s # Interval between checks — every 10 seconds
      timeout: 5s # Timeout for the check response
      retries: 5 # After 5 consecutive failed attempts, the container is considered "unhealthy"

    restart: unless-stopped
    # Automatically restart the container if it crashes
    # If the container was stopped manually, don't restart

    networks:
      - microservices-net
      # Connect to the common network so other microservices (e.g., Order service) can find this container by name "postgres-order"

volumes: # Volume section — defining what disk resources Docker creates and uses
  postgres_order_data:
  # Named volume for storing Order service data in PostgreSQL
  # Allows preserving the database state even after container restart

networks: # Network settings
  microservices-net:
    external: true
    # We don't create a new network, but connect to the already existing common network "microservices-net"
    # This network is created once in docker-compose.yml or manually via docker network create
