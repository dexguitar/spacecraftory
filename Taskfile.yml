version: "3"

# Global project variables
vars:
  GO_VERSION: "1.25.2"
  GOLANGCI_LINT_VERSION: "v2.1.5"
  GCI_VERSION: "v0.13.6"
  GOFUMPT_VERSION: "v0.8.0"
  BUF_VERSION: "1.53.0"
  PROTOC_GEN_GO_VERSION: "v1.36.6"
  PROTOC_GEN_GO_GRPC_VERSION: "v1.5.1"
  PROTOC_GEN_GRPC_GATEWAY_VERSION: "v2.27.3"
  PROTOC_GEN_VALIDATE_VERSION: "v1.2.1"
  PROTOC_GEN_OPENAPIV2_VERSION: "v2.26.3"
  OGEN_VERSION: "v1.16.0"
  YQ_VERSION: "v4.45.2"
  MOCKERY_VERSION: "v2.53.3"
  GRPCURL_VERSION: "v1.9.3"
  ENVSUBST_VERSION: "v1.4.3"

  BIN_DIR: "{{.ROOT_DIR}}/bin"
  GOLANGCI_LINT: "{{.BIN_DIR}}/golangci-lint"
  GCI: "{{.BIN_DIR}}/gci"
  GOFUMPT: "{{.BIN_DIR}}/gofumpt"
  BUF: "{{.BIN_DIR}}/buf"
  OGEN: "{{.BIN_DIR}}/ogen"
  YQ: "{{.BIN_DIR}}/yq"
  PROTOC_GEN_GO: "{{.BIN_DIR}}/protoc-gen-go"
  PROTOC_GEN_GO_GRPC: "{{.BIN_DIR}}/protoc-gen-go-grpc"
  PROTOC_GEN_GRPC_GATEWAY: "{{.BIN_DIR}}/protoc-gen-grpc-gateway"
  PROTOC_GEN_VALIDATE: "{{.BIN_DIR}}/protoc-gen-validate"
  PROTOC_GEN_OPENAPIV2: "{{.BIN_DIR}}/protoc-gen-openapiv2"
  MOCKERY: "{{.BIN_DIR}}/mockery"
  GRPCURL: "{{.BIN_DIR}}/grpcurl"
  ENVSUBST: "{{.BIN_DIR}}/envsubst"
  ENVDIR: "{{.ROOT_DIR}}/deploy/env"

  NODE_MODULES_DIR: "{{.ROOT_DIR}}/node_modules/.bin"
  REDOCLY: "{{.NODE_MODULES_DIR}}/redocly"

  OPEN_API_ORDER_V1_BASE: "{{.ROOT_DIR}}/shared/api/order/v1/order.openapi.yaml"
  OPEN_API_ORDER_V1_BUNDLE: "{{.ROOT_DIR}}/shared/api/bundles/order.openapi.v1.bundle.yaml"

  OPEN_API_FILES: "{{.ROOT_DIR}}/shared/api/bundles"
  COVERAGE_DIR: "{{.ROOT_DIR}}/coverage"
  COVERAGE_FILE: total.out
  ORDER_MIGRATIONS_DIR: "./order/migrations"
  POSTGRES_DSN: "postgres://order-service-user:order-service-password@localhost:5432/order-service?sslmode=disable"

  MODULES: inventory order payment platform iam notification
  SERVICES: core,assembly,inventory,order,payment,iam,notification

tasks:
  install-formatters:
    desc: "Installs gci and gofumpt formatters in ./bin"
    summary: |
      This task checks for the presence of gofumpt and gci code formatting tools in the bin directory.
      If the tools are not found, they will be automatically installed with the specified versions.

      Used tools:
        - gofumpt: for Go code formatting
        - gci: for sorting Go imports
    cmds:
      - |
        [ -f {{.GOFUMPT}} ] || {
          echo 'üì¶ Installing gofumpt {{.GOFUMPT_VERSION}}...'
          GOBIN={{.BIN_DIR}} go install mvdan.cc/gofumpt@{{.GOFUMPT_VERSION}}
        }
        [ -f {{.GCI}} ] || {
          echo 'üì¶ Installing gci {{.GCI_VERSION}}...'
          GOBIN={{.BIN_DIR}} go install github.com/daixiang0/gci@{{.GCI_VERSION}}
        }
    status:
      - test -x {{.GOFUMPT}}
      - test -x {{.GCI}}

  format:
    desc: "Formats entire project with gofumpt + gci, excluding mocks"
    summary: |
      Formats all Go files in the project using gofumpt for code standardization
      and gci for import sorting, excluding files in mocks directories.

      Uses tools:
        - gofumpt: for standardizing formatting
        - gci: for sorting imports by standard groups
    deps: [install-formatters]
    cmds:
      - |
        echo "üßº Formatting with gofumpt..."

        for module in {{.MODULES}}; do
          if [ -d "$module" ]; then
            echo "üßº Formatting $module"
            find $module -type f -name '*.go' ! -path '*/mocks/*' -exec {{.GOFUMPT}} -extra -w {} +
          fi
        done
      - |
        echo "üéØ Sorting imports with gci..."

        for module in {{.MODULES}}; do
          if [ -d "$module" ]; then
            echo "üéØ Sorting imports in $module"
            find $module -type f -name '*.go' ! -path '*/mocks/*' -exec {{.GCI}} write -s standard -s default -s "prefix(github.com/dexguitar/spacecraftory)" {} +
          fi
        done

  install-golangci-lint:
    desc: "Installs golangci-lint in bin directory"
    summary: |
      Checks for the presence of golangci-lint in the bin directory.
      If the tool is not found, automatically installs it via go install.

      Installing version: {{.GOLANGCI_LINT_VERSION}}
    cmds:
      - |
        [ -f {{.GOLANGCI_LINT}} ] || {
          mkdir -p {{.BIN_DIR}}
          echo "üì¶ Installing golangci-lint {{.GOLANGCI_LINT_VERSION}}..."
          GOBIN={{.BIN_DIR}} go install github.com/golangci/golangci-lint/v2/cmd/golangci-lint@{{.GOLANGCI_LINT_VERSION}}
        }
    status:
      - test -x {{.GOLANGCI_LINT}}

  lint:
    desc: "Runs golangci-lint for all modules"
    summary: |
      Runs golangci-lint linter for all project modules.
      The linter checks code for compliance with quality standards and best practices.
      Checking includes security check via gosec (built into golangci-lint).

      Dependencies:
        - install-golangci-lint: automatically installs the linter
        - format: formats code before checking
    deps: [install-golangci-lint]
    vars:
      MODULES: "{{.MODULES}}"
      GOLANGCI_LINT: "{{.GOLANGCI_LINT}}"
    cmds:
      - |
        set -e
        ERR=0
        echo "üîç Linting all modules..."
        for mod in {{.MODULES}}; do
          if [ -d "$mod" ]; then
            echo "üîç Linting $mod module"
            {{.GOLANGCI_LINT}} run $mod/... --config=.golangci.yml || ERR=1
          fi
        done
        exit $ERR

  install-buf:
    desc: "Installs Buf in bin directory"
    cmds:
      - |
        [ -f {{.BUF}} ] || {
          mkdir -p {{.BIN_DIR}} tmp-buf
          curl -sSL \
            "https://github.com/bufbuild/buf/releases/download/v{{.BUF_VERSION}}/buf-$(uname -s)-$(uname -m).tar.gz" \
            | tar -xz -C tmp-buf
          mv tmp-buf/buf/bin/buf {{.BUF}}
          rm -rf tmp-buf
          chmod +x {{.BUF}}
        }

  proto:install-plugins:
    desc: "Installs protoc plugins in bin directory"
    cmds:
      - |
        [ -f {{.PROTOC_GEN_GO}} ] || {
          echo 'üì¶ Installing protoc-gen-go...'
          GOBIN={{.BIN_DIR}} go install google.golang.org/protobuf/cmd/protoc-gen-go@{{.PROTOC_GEN_GO_VERSION}}
        }
        [ -f {{.PROTOC_GEN_GO_GRPC}} ] || {
          echo 'üì¶ Installing protoc-gen-go-grpc...'
          GOBIN={{.BIN_DIR}} go install google.golang.org/grpc/cmd/protoc-gen-go-grpc@{{.PROTOC_GEN_GO_GRPC_VERSION}}
        }
        [ -f {{.PROTOC_GEN_GRPC_GATEWAY}} ] || {
          echo 'üì¶ Installing protoc-gen-grpc-gateway...'
          GOBIN={{.BIN_DIR}} go install github.com/grpc-ecosystem/grpc-gateway/v2/protoc-gen-grpc-gateway@{{.PROTOC_GEN_GRPC_GATEWAY_VERSION}}
        }
        [ -f {{.PROTOC_GEN_VALIDATE}} ] || {
          echo 'üì¶ Installing protoc-gen-validate...'
          GOBIN={{.BIN_DIR}} go install github.com/envoyproxy/protoc-gen-validate@{{.PROTOC_GEN_VALIDATE_VERSION}}
        }
        [ -f {{.PROTOC_GEN_OPENAPIV2}} ] || {
          echo 'üì¶ Installing protoc-gen-openapiv2...'
          GOBIN={{.BIN_DIR}} go install github.com/grpc-ecosystem/grpc-gateway/v2/protoc-gen-openapiv2@{{.PROTOC_GEN_OPENAPIV2_VERSION}}
        }

  proto:gen:
    deps: [install-buf, proto:install-plugins, proto:update-deps, proto:lint]
    desc: Generate Go code from .proto
    dir: shared/proto
    cmds:
      - "{{.BUF}} generate"

  proto:update-deps:
    deps: [install-buf]
    desc: Update dependencies in .proto files
    dir: shared/proto
    cmds:
      - "{{.BUF}} dep update"

  proto:lint:
    deps: [install-buf, proto:install-plugins]
    desc: Check .proto files for style compliance
    dir: shared/proto
    cmds:
      - "{{.BUF}} lint"

  redocly-cli:install:
    desc: Install Redocly CLI locally
    cmds:
      - |
        [ -f {{.REDOCLY}} ] || {
          npm ci
        } || {
          echo "üì¶ Installing redocly-cli..."
          npm install
        }

  redocly-cli:order-v1-bundle:
    desc: Bundle OpenAPI into a single file via local redocly
    deps: [redocly-cli:install]
    cmds:
      - "{{.REDOCLY}} bundle {{.OPEN_API_ORDER_V1_BASE}} -o {{.OPEN_API_ORDER_V1_BUNDLE}}"

  redocly-cli:bundle:
    desc: Bundle all OpenAPI schemas into common files via local redocly
    deps: [redocly-cli:install]
    cmds:
      - task: redocly-cli:order-v1-bundle

  ogen:install:
    desc: "Downloads ogen to bin folder"
    cmds:
      - |
        [ -f {{.OGEN}} ] || {
          mkdir -p {{.BIN_DIR}}
          GOBIN={{.BIN_DIR}} go install github.com/ogen-go/ogen/cmd/ogen@{{.OGEN_VERSION}}
        }

  ogen:gen:
    desc: "Generate Go code from all OpenAPI declarations with x-ogen"
    deps: [ogen:install, yq:install]
    cmds:
      - task: redocly-cli:bundle
      - |
        find {{.OPEN_API_FILES}} -name '*.yaml' -o -name '*.yml' | while read -r file; do
          if [ -f "$file" ] && grep -q 'x-ogen:' "$file"; then
            echo "üöÄ Generating from: $file"
            target=$({{.YQ}} e '."x-ogen".target' "$file")
            package=$({{.YQ}} e '."x-ogen".package' "$file")
            echo "üìÅ Target: $target"
            echo "üì¶ Package: $package"
            {{.OGEN}} \
              --target "$target" \
              --package "$package" \
              --clean \
              "$file" || exit 1
          fi
        done

  gen:
    desc: "Generate all proto and OpenAPI declarations"
    cmds:
      - task: proto:gen
      - task: ogen:gen

  deps:update:
    desc: "Update dependencies in go.mod in all modules"
    cmds:
      - |
        echo "üîÑ Updating dependencies in go.mod in all modules"
        for mod in {{.MODULES}}; do
          if [ -d "$mod" ]; then
            echo "üîÑ Updating dependencies in $mod"
            (cd "$mod" && go mod tidy -compat=1.25.2) || exit 1
          fi
        done

  yq:install:
    desc: "Installs yq in bin/ when needed"
    cmds:
      - |
        [ -f {{.YQ}} ] || {
          echo 'üì¶ Installing yq...'
          GOBIN={{.BIN_DIR}} go install github.com/mikefarah/yq/v4@{{.YQ_VERSION}}
        }

  mockery:install:
    desc: "Installing mockery in ./bin"
    cmds:
      - |
        [ -f {{.MOCKERY}} ] || {
          echo 'üì¶ Installing mockery...'
          GOBIN={{.BIN_DIR}} go install github.com/vektra/mockery/v2@{{.MOCKERY_VERSION}}
        }
    status:
      - test -x {{.MOCKERY}}

  mockery:gen:
    desc: "Generate mocks for interfaces using mockery"
    deps: [mockery:install]
    cmds:
      - |
        echo 'üß™ Generating mocks...'
        {{.MOCKERY}}

  test-coverage:
    desc: "Tests with business logic coverage (service/repository), report for each module + total"
    cmds:
      - |
        echo "üß™ Starting coverage calculation..."
        rm -rf {{.COVERAGE_DIR}}
        mkdir -p {{.COVERAGE_DIR}}

        ERR=0
        for mod in {{.MODULES}}; do
          echo "üì¶ Processing module: $mod"

          TARGET_PKGS=$(go list ./$mod/... \
            | grep -E '/(internal/(service|repository))' \
            | grep -vE '/(mocks|testdata|pkg|api|proto|pb|cmd)' \
            | paste -sd "," -)

          if [ -z "$TARGET_PKGS" ]; then
            echo "‚ö†Ô∏è  No suitable packages in $mod"
            continue
          fi

          go test -coverpkg="$TARGET_PKGS" \
            -coverprofile={{.COVERAGE_DIR}}/$mod.out \
            -covermode=atomic \
            $(echo "$TARGET_PKGS" | tr "," " ") || ERR=1
        done

        if [ $ERR -ne 0 ]; then
          echo "‚ùå Errors during tests"
          exit $ERR
        fi

        echo
        echo "üìä Coverage for each module:"
        for mod in {{.MODULES}}; do
          OUTFILE="{{.COVERAGE_DIR}}/$mod.out"
          if [ -f "$OUTFILE" ]; then
            printf " ‚Ä¢ %s: " "$mod"
            go tool cover -func="$OUTFILE" | tail -n1
          fi
        done

        echo
        echo "üì¶ Merging all coverage..."
        {
          echo "mode: atomic"
          find {{.COVERAGE_DIR}} -type f -name '*.out' ! -name '{{.COVERAGE_FILE}}' \
            -exec grep -h -v "^mode:" {} +
        } > {{.COVERAGE_DIR}}/{{.COVERAGE_FILE}}

        echo
        echo "üßæ Total coverage for all modules:"
        go tool cover -func={{.COVERAGE_DIR}}/{{.COVERAGE_FILE}} | tail -n1

  coverage:html:
    desc: "Generate HTML coverage report and open it in the browser"
    deps: [test-coverage]
    cmds:
      - |
        OUTPUT={{.COVERAGE_DIR}}/coverage.html
        echo "üåê Generating HTML report..."
        go tool cover -html={{.COVERAGE_DIR}}/{{.COVERAGE_FILE}} -o $OUTPUT

        echo "üöÄ Opening $OUTPUT"
        if command -v open &> /dev/null; then
          open $OUTPUT  # macOS
        elif command -v xdg-open &> /dev/null; then
          xdg-open $OUTPUT  # Linux
        else
          echo "üìÇ Report saved in $OUTPUT (open manually)"
        fi

  test:
    desc: "–ó–∞–ø—É—Å–∫–∞–µ—Ç —é–Ω–∏—Ç-—Ç–µ—Å—Ç—ã –¥–ª—è –≤—Å–µ—Ö –º–æ–¥—É–ª–µ–π"
    summary: |
      –ó–∞–ø—É—Å–∫–∞–µ—Ç —é–Ω–∏—Ç-—Ç–µ—Å—Ç—ã –¥–ª—è —É–∫–∞–∑–∞–Ω–Ω—ã—Ö –º–æ–¥—É–ª–µ–π –ø—Ä–æ–µ–∫—Ç–∞.
      –ú–æ–∂–Ω–æ —É–∫–∞–∑–∞—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –º–æ–¥—É–ª–∏ —á–µ—Ä–µ–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é MODULES.
      –ò—Å–∫–ª—é—á–∞—é—Ç—Å—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è—Ö integration –∏ tests/integration.
      –¢–∞–∫–∂–µ –∏—Å–∫–ª—é—á–∞—é—Ç—Å—è —Ç–µ—Å—Ç—ã —Å —Ç–µ–≥–æ–º "integration".
    cmds:
      - |
        ERR=0
        for mod in {{.MODULES}}; do
          if [ -d "$mod" ]; then
            echo "üß™ –¢–µ—Å—Ç–∏—Ä—É–µ–º –º–æ–¥—É–ª—å $mod (—Ç–æ–ª—å–∫–æ —é–Ω–∏—Ç-—Ç–µ—Å—Ç—ã)"
            go test -v -tags="!integration" $(go list ./$mod/... | grep -v -E '(/integration|/tests/integration|/integrationtests)') || ERR=1
          fi
        done
        exit $ERR

  up-core:
    desc: Deploy core containers
    dir: deploy/compose/core
    cmds:
      - echo "[task] üöÄ Deploying core containers"
      - docker compose up --build --detach

  down-core:
    desc: Stop and remove core containers
    dir: deploy/compose/core
    cmds:
      - echo "[task] üõë Stopping core containers"
      - docker compose down --volumes

  up-inventory:
    desc: Deploy Inventory service and all its dependencies
    dir: deploy/compose/inventory
    cmds:
      - echo "[task] üì¶ Deploying Inventory with dependencies"
      - docker compose up --build --detach

  down-inventory:
    desc: Stop and remove Inventory service and all its dependencies
    dir: deploy/compose/inventory
    cmds:
      - echo "[task] üõë Stopping Inventory with dependencies"
      - docker compose down --volumes

  up-order:
    desc: Deploy Order service and all its dependencies
    dir: deploy/compose/order
    cmds:
      - echo "[task] üì¶ Deploying Order with dependencies"
      - docker compose up --build --detach

  down-order:
    desc: Stop and remove Order service and all its dependencies
    dir: deploy/compose/order
    cmds:
      - echo "[task] üõë Stopping Order with dependencies"
      - docker compose down --volumes

  up-iam:
    desc: –ü–æ–¥–Ω—è—Ç—å IAM —Å–µ—Ä–≤–∏—Å –∏ –≤—Å–µ –µ–≥–æ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
    dir: deploy/compose/iam
    cmds:
      - echo "[task] üîê –ü–æ–¥–Ω–∏–º–∞–µ–º IAM —Å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—è–º–∏"
      - docker compose up --build --detach

  down-iam:
    desc: –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏ —É–¥–∞–ª–∏—Ç—å IAM —Å–µ—Ä–≤–∏—Å –∏ –≤—Å–µ –µ–≥–æ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
    dir: deploy/compose/iam
    cmds:
      - echo "[task] üõë –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º IAM —Å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—è–º–∏"
      - docker compose down --volumes

  up-all:
    desc: Deploy all services one by one with dependencies
    cmds:
      - task up-core
      - task up-inventory
      - task up-order
      - task up-iam

  down-all:
    desc: Stop and remove all services one by one with dependencies
    cmds:
      - task down-core
      - task down-inventory
      - task down-order

  grpcurl:install:
    desc: "Installs grpcurl in bin directory"
    cmds:
      - |
        [ -f {{.GRPCURL}} ] || {
          echo 'üì¶ Installing grpcurl {{.GRPCURL_VERSION}}...'
          GOBIN={{.BIN_DIR}} go install github.com/fullstorydev/grpcurl/cmd/grpcurl@{{.GRPCURL_VERSION}}
        }
    status:
      - test -x {{.GRPCURL}}

  test-iam:
    desc: "üîê –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ IAM —Å–µ—Ä–≤–∏—Å–∞ (—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è, –ª–æ–≥–∏–Ω, whoami)"
    deps: [grpcurl:install]
    silent: true
    cmds:
      - |
        echo "üîê –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ IAM —Å–µ—Ä–≤–∏—Å–∞"

        # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        TIMESTAMP=$(date +%s)
        USER_EMAIL="test-user-$TIMESTAMP@example.com"
        USER_PASSWORD="SecurePassword123!"

        echo "üìù –¢–µ—Å—Ç 1: –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"
        REGISTER_RESPONSE=$({{.GRPCURL}} -plaintext -d "{\"info\":{\"info\":{\"email\":\"$USER_EMAIL\",\"login\":\"$USER_EMAIL\"},\"password\":\"$USER_PASSWORD\"}}" localhost:50053 user.v1.UserService/Register)

        if [[ -z "$REGISTER_RESPONSE" || "$REGISTER_RESPONSE" == *"error"* ]]; then
          echo "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è."
          echo "üîç –û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞: $REGISTER_RESPONSE"
          exit 1
        fi

        # –ò–∑–≤–ª–µ–∫–∞–µ–º UUID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        USER_UUID=$(echo $REGISTER_RESPONSE | grep -o '"userUuid": "[^"]*' | cut -d'"' -f4)
        if [ -z "$USER_UUID" ]; then
          echo "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∏–∑–≤–ª–µ—á—å UUID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ –æ—Ç–≤–µ—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏."
          echo "üîç –û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞: $REGISTER_RESPONSE"
          exit 1
        fi
        echo "‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω: $USER_EMAIL (UUID: $USER_UUID)"

        echo
        echo "üîë –¢–µ—Å—Ç 2: –õ–æ–≥–∏–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"
        LOGIN_RESPONSE=$({{.GRPCURL}} -plaintext -d "{\"login\":\"$USER_EMAIL\",\"password\":\"$USER_PASSWORD\"}" localhost:50053 auth.v1.AuthService/Login)

        if [[ -z "$LOGIN_RESPONSE" || "$LOGIN_RESPONSE" == *"error"* ]]; then
          echo "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –≤–æ–π—Ç–∏ –≤ —Å–∏—Å—Ç–µ–º—É."
          echo "üîç –û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞: $LOGIN_RESPONSE"
          exit 1
        fi

        # –ò–∑–≤–ª–µ–∫–∞–µ–º session UUID
        SESSION_UUID=$(echo $LOGIN_RESPONSE | grep -o '"sessionUuid": "[^"]*' | cut -d'"' -f4)
        if [ -z "$SESSION_UUID" ]; then
          echo "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∏–∑–≤–ª–µ—á—å session UUID –∏–∑ –æ—Ç–≤–µ—Ç–∞ –ª–æ–≥–∏–Ω–∞."
          echo "üîç –û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞: $LOGIN_RESPONSE"
          exit 1
        fi
        echo "‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–æ—à–µ–ª –≤ —Å–∏—Å—Ç–µ–º—É. Session UUID: $SESSION_UUID"

        echo
        echo "üë§ –¢–µ—Å—Ç 3: –ü—Ä–æ–≤–µ—Ä–∫–∞ whoami —Å session UUID"
        WHOAMI_RESPONSE=$({{.GRPCURL}} -plaintext -d "{\"session_uuid\":\"$SESSION_UUID\"}" localhost:50053 auth.v1.AuthService/WhoAmI)

        if [[ -z "$WHOAMI_RESPONSE" || "$WHOAMI_RESPONSE" == *"error"* ]]; then
          echo "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç–µ–∫—É—â–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ."
          echo "üîç –û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞: $WHOAMI_RESPONSE"
          exit 1
        fi

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ UUID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å–æ–≤–ø–∞–¥–∞–µ—Ç
        WHOAMI_UUID=$(echo $WHOAMI_RESPONSE | sed -n 's/.*"user"[^"]*"uuid": *"\([^"]*\)".*/\1/p')
        if [[ "$WHOAMI_UUID" != "$USER_UUID" ]]; then
          echo "‚ùå UUID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç. –û–∂–∏–¥–∞–ª—Å—è: $USER_UUID, –ø–æ–ª—É—á–µ–Ω: $WHOAMI_UUID"
          exit 1
        fi
        echo "‚úÖ Whoami —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ. UUID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: $WHOAMI_UUID"

        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ –¥—Ä—É–≥–∏—Ö —Ç–µ—Å—Ç–∞—Ö
        echo "export TEST_USER_UUID=\"$USER_UUID\"" > /tmp/test_auth_data.sh
        echo "export TEST_SESSION_UUID=\"$SESSION_UUID\"" >> /tmp/test_auth_data.sh
        echo "export TEST_USER_EMAIL=\"$USER_EMAIL\"" >> /tmp/test_auth_data.sh

        echo
        echo "üéâ –í—Å–µ —Ç–µ—Å—Ç—ã IAM –≤—ã–ø–æ–ª–Ω–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ!"
        echo "üìÑ –î–∞–Ω–Ω—ã–µ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ /tmp/test_auth_data.sh"

  test-api-auth-rejection:
    desc: "üîí –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç–∏ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è –Ω–µ–∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤"
    silent: true
    cmds:
      - |
        echo "üîí –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç–∏ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è –Ω–µ–∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤"

        # –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –∏–∑ IAM —Ç–µ—Å—Ç–∞
        if [ -f /tmp/test_auth_data.sh ]; then
          source /tmp/test_auth_data.sh
          echo "üìã –ò—Å–ø–æ–ª—å–∑—É–µ–º –¥–∞–Ω–Ω—ã–µ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö:"
          echo "   - User UUID: $TEST_USER_UUID"
          echo "   - Session UUID: $TEST_SESSION_UUID"
          echo "   - Email: $TEST_USER_EMAIL"
        else
          echo "‚ùå –î–∞–Ω–Ω—ã–µ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã. –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–Ω–∞—á–∞–ª–∞ test-iam."
          exit 1
        fi

        # –ü–æ–ª—É—á–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ —Ç–µ—Å—Ç–∞—Ö
        echo "üì¶ –ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö –∏–∑ Inventory..."
        PARTS_RESPONSE=$({{.GRPCURL}} -plaintext -H "session-uuid: $TEST_SESSION_UUID" -d '{"filter":{}}' localhost:50051 inventory.v1.InventoryService/ListParts)
        PART_UUID=$(echo $PARTS_RESPONSE | grep -o '"uuid": "[^"]*' | head -1 | cut -d'"' -f4)

        echo
        echo "üîç –¢–µ—Å—Ç 1: –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—Ç–∫–∞–∑–∞ –¥–æ—Å—Ç—É–ø–∞ –±–µ–∑ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ (Inventory gRPC)"
        UNAUTHORIZED_RESPONSE=$({{.GRPCURL}} -plaintext -d '{"filter":{}}' localhost:50051 inventory.v1.InventoryService/ListParts 2>&1 || true)

        if [[ "$UNAUTHORIZED_RESPONSE" != *"Unauthenticated"* ]]; then
          echo "‚ö†Ô∏è  –ó–∞–ø—Ä–æ—Å –±–µ–∑ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –Ω–µ –±—ã–ª –æ—Ç–∫–ª–æ–Ω–µ–Ω (–æ–∂–∏–¥–∞–µ–º–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ –º–æ–∂–µ—Ç –æ—Ç–ª–∏—á–∞—Ç—å—Å—è)."
          echo "üîç –û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞: $UNAUTHORIZED_RESPONSE"
        else
          echo "‚úÖ –ó–∞–ø—Ä–æ—Å –±–µ–∑ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ—Ç–∫–ª–æ–Ω–µ–Ω"
        fi

        echo
        echo "üîç –¢–µ—Å—Ç 2: –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—Ç–∫–∞–∑–∞ –¥–æ—Å—Ç—É–ø–∞ –±–µ–∑ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ (Order REST API)"
        UNAUTHORIZED_ORDER_RESPONSE=$(curl -s -X POST "http://localhost:8080/api/v1/orders" \
          -H "Content-Type: application/json" \
          -d "{\"user_uuid\":\"$TEST_USER_UUID\",\"part_uuids\":[\"$PART_UUID\"]}")

        if [[ "$UNAUTHORIZED_ORDER_RESPONSE" != *"unauthorized"* && "$UNAUTHORIZED_ORDER_RESPONSE" != *"Unauthorized"* && "$UNAUTHORIZED_ORDER_RESPONSE" != *"Authentication required"* && "$UNAUTHORIZED_ORDER_RESPONSE" != *"MISSING_SESSION"* ]]; then
          echo "‚ö†Ô∏è  –ó–∞–ø—Ä–æ—Å –±–µ–∑ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –∫ Order API –Ω–µ –±—ã–ª –æ—Ç–∫–ª–æ–Ω–µ–Ω (–æ–∂–∏–¥–∞–µ–º–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ –º–æ–∂–µ—Ç –æ—Ç–ª–∏—á–∞—Ç—å—Å—è)."
          echo "üîç –û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞: $UNAUTHORIZED_ORDER_RESPONSE"
        else
          echo "‚úÖ –ó–∞–ø—Ä–æ—Å –±–µ–∑ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –∫ Order API –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ—Ç–∫–ª–æ–Ω–µ–Ω"
        fi

        echo
        echo "üéâ –í—Å–µ —Ç–µ—Å—Ç—ã –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è –Ω–µ–∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –∑–∞–≤–µ—Ä—à–µ–Ω—ã!"

  test-api-with-auth:
    desc: "‚úÖ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ API –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å–æ–≤ —Å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–µ–π"
    silent: true
    cmds:
      - |
        echo "‚úÖ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ API –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å–æ–≤ —Å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–µ–π"

        # –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –∏–∑ IAM —Ç–µ—Å—Ç–∞
        if [ -f /tmp/test_auth_data.sh ]; then
          source /tmp/test_auth_data.sh
          echo "üìã –ò—Å–ø–æ–ª—å–∑—É–µ–º –¥–∞–Ω–Ω—ã–µ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏:"
          echo "   - User UUID: $TEST_USER_UUID"
          echo "   - Session UUID: $TEST_SESSION_UUID"
          echo "   - Email: $TEST_USER_EMAIL"
        else
          echo "‚ùå –î–∞–Ω–Ω—ã–µ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã. –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–Ω–∞—á–∞–ª–∞ test-iam."
          exit 1
        fi

        echo
        echo "üì¶ –¢–µ—Å—Ç 1: –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –¥–µ—Ç–∞–ª–µ–π –∏–∑ Inventory (—Å –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–µ–π)"
        PARTS_RESPONSE=$({{.GRPCURL}} -plaintext -H "session-uuid: $TEST_SESSION_UUID" -d '{"filter":{}}' localhost:50051 inventory.v1.InventoryService/ListParts)

        if [[ -z "$PARTS_RESPONSE" || "$PARTS_RESPONSE" == *"error"* ]]; then
          echo "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –¥–µ—Ç–∞–ª–µ–π."
          echo "üîç –û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞: $PARTS_RESPONSE"
          exit 1
        fi

        # –ò–∑–≤–ª–µ–∫–∞–µ–º UUID –ø–µ—Ä–≤–æ–π –¥–µ—Ç–∞–ª–∏ –¥–ª—è –¥–∞–ª—å–Ω–µ–π—à–∏—Ö —Ç–µ—Å—Ç–æ–≤
        PART_UUID=$(echo $PARTS_RESPONSE | grep -o '"uuid": "[^"]*' | head -1 | cut -d'"' -f4)
        if [ -z "$PART_UUID" ]; then
          echo "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ UUID –¥–µ—Ç–∞–ª–∏ –≤ –æ—Ç–≤–µ—Ç–µ."
          echo "üîç –û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞: $PARTS_RESPONSE"
          exit 1
        fi
        echo "‚úÖ –£—Å–ø–µ—à–Ω–æ –ø–æ–ª—É—á–µ–Ω —Å–ø–∏—Å–æ–∫ –¥–µ—Ç–∞–ª–µ–π, –ø–µ—Ä–≤–∞—è UUID: $PART_UUID"

        echo
        echo "üîç –¢–µ—Å—Ç 2: –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –¥–µ—Ç–∞–ª–∏ –ø–æ UUID (—Å –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–µ–π)"
        PART_RESPONSE=$({{.GRPCURL}} -plaintext -H "session-uuid: $TEST_SESSION_UUID" -d "{\"uuid\":\"$PART_UUID\"}" localhost:50051 inventory.v1.InventoryService/GetPart)

        if [[ -z "$PART_RESPONSE" || "$PART_RESPONSE" == *"error"* ]]; then
          echo "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –¥–µ—Ç–∞–ª–∏."
          echo "üîç –û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞: $PART_RESPONSE"
          exit 1
        fi

        # –ò–∑–≤–ª–µ–∫–∞–µ–º –∏–º—è –¥–µ—Ç–∞–ª–∏ 
        PART_NAME=$(echo $PART_RESPONSE | grep -o '"name": "[^"]*' | cut -d'"' -f4)
        if [ -z "$PART_NAME" ]; then
          echo "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∏–∑–≤–ª–µ—á—å –∏–º—è –¥–µ—Ç–∞–ª–∏ –∏–∑ –æ—Ç–≤–µ—Ç–∞."
          echo "üîç –û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞: $PART_RESPONSE"
          exit 1
        fi
        echo "‚úÖ –£—Å–ø–µ—à–Ω–æ –ø–æ–ª—É—á–µ–Ω–∞ –¥–µ—Ç–∞–ª—å: $PART_NAME"

        echo
        echo "üìù –¢–µ—Å—Ç 3: –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞ (REST API —Å –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–µ–π)"
        ORDER_RESPONSE=$(curl -s -X POST "http://localhost:8080/api/v1/orders" \
          -H "Content-Type: application/json" \
          -H "X-Session-Uuid: $TEST_SESSION_UUID" \
          -d "{\"user_uuid\":\"$TEST_USER_UUID\",\"part_uuids\":[\"$PART_UUID\"]}")

        if [[ -z "$ORDER_RESPONSE" || "$ORDER_RESPONSE" == *"error"* ]]; then
          if [[ "$ORDER_RESPONSE" == *"missing session-uuid in metadata"* ]]; then
            echo "‚ö†Ô∏è  –ó–∞–∫–∞–∑ –Ω–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å: Order —Å–µ—Ä–≤–∏—Å –Ω–µ –ø–µ—Ä–µ–¥–∞–µ—Ç –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é –≤ Inventory —Å–µ—Ä–≤–∏—Å"
            echo "üîç –û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞: $ORDER_RESPONSE"
            echo "‚ÑπÔ∏è  –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —Ç–µ—Å—Ç—ã –∑–∞–∫–∞–∑–æ–≤, —Ç–∞–∫ –∫–∞–∫ —Ç—Ä–µ–±—É–µ—Ç—Å—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –º–µ–∂—Å–µ—Ä–≤–∏—Å–Ω–æ–π –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏"
            echo
            echo "üéâ –û—Å–Ω–æ–≤–Ω—ã–µ —Ç–µ—Å—Ç—ã API –≤—ã–ø–æ–ª–Ω–µ–Ω—ã! (–ú–µ–∂—Å–µ—Ä–≤–∏—Å–Ω–∞—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è —Ç—Ä–µ–±—É–µ—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏)"
            
            # –û—á–∏—â–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã  
            rm -f /tmp/test_auth_data.sh
          else
            echo "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –∑–∞–∫–∞–∑."
            echo "üîç –û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞: $ORDER_RESPONSE"
            exit 1
          fi
        else
          # –ò–∑–≤–ª–µ–∫–∞–µ–º UUID –∑–∞–∫–∞–∑–∞ —Å —É—á–µ—Ç–æ–º —Ä–∞–∑–Ω—ã—Ö —Ñ–æ—Ä–º–∞—Ç–æ–≤ JSON
        ORDER_UUID=$(echo $ORDER_RESPONSE | grep -o '"order_uuid":"[^"]*' | cut -d'"' -f4)
        if [ -z "$ORDER_UUID" ]; then
          ORDER_UUID=$(echo $ORDER_RESPONSE | grep -o '"order_uuid": "[^"]*' | cut -d'"' -f4)
          if [ -z "$ORDER_UUID" ]; then
            echo "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∏–∑–≤–ª–µ—á—å UUID –∑–∞–∫–∞–∑–∞ –∏–∑ –æ—Ç–≤–µ—Ç–∞."
            echo "üîç –û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞: $ORDER_RESPONSE"
            exit 1
          fi
        fi
        echo "‚úÖ –£—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω –∑–∞–∫–∞–∑ —Å UUID: $ORDER_UUID"

        echo
        echo "üìä –¢–µ—Å—Ç 4: –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞—á–∞–ª—å–Ω–æ–≥–æ —Å—Ç–∞—Ç—É—Å–∞ –∑–∞–∫–∞–∑–∞ (–¥–æ–ª–∂–µ–Ω –±—ã—Ç—å PENDING_PAYMENT)"
        ORDER_INFO_RESPONSE=$(curl -s -X GET "http://localhost:8080/api/v1/orders/$ORDER_UUID" \
          -H "X-Session-Uuid: $TEST_SESSION_UUID")

        if [[ -z "$ORDER_INFO_RESPONSE" || "$ORDER_INFO_RESPONSE" == *"error"* ]]; then
          echo "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∑–∞–∫–∞–∑–µ."
          echo "üîç –û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞: $ORDER_INFO_RESPONSE"
          exit 1
        fi

        # –ò–∑–≤–ª–µ–∫–∞–µ–º —Å—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞ —Å —É—á–µ—Ç–æ–º —Ä–∞–∑–Ω—ã—Ö —Ñ–æ—Ä–º–∞—Ç–æ–≤ JSON
        ORDER_STATUS=$(echo $ORDER_INFO_RESPONSE | grep -o '"status":"[^"]*' | cut -d'"' -f4)
        if [ -z "$ORDER_STATUS" ]; then
          ORDER_STATUS=$(echo $ORDER_INFO_RESPONSE | grep -o '"status": "[^"]*' | cut -d'"' -f4)
          if [ -z "$ORDER_STATUS" ]; then
            echo "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∏–∑–≤–ª–µ—á—å —Å—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞ –∏–∑ –æ—Ç–≤–µ—Ç–∞."
            echo "üîç –û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞: $ORDER_INFO_RESPONSE"
            exit 1
          fi
        fi

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –Ω–∞—á–∞–ª—å–Ω—ã–π —Å—Ç–∞—Ç—É—Å PENDING_PAYMENT
        if [[ "$ORDER_STATUS" != *"PENDING_PAYMENT"* ]]; then
          echo "‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –Ω–∞—á–∞–ª—å–Ω—ã–π —Å—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞. –û–∂–∏–¥–∞–ª—Å—è PENDING_PAYMENT, –ø–æ–ª—É—á–µ–Ω: $ORDER_STATUS"
          exit 1
        fi
        echo "‚úÖ –ù–∞—á–∞–ª—å–Ω—ã–π —Å—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π: $ORDER_STATUS"

        echo
        echo "üí∞ –¢–µ—Å—Ç 5: –û–ø–ª–∞—Ç–∞ –∑–∞–∫–∞–∑–∞ (REST API —Å –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–µ–π)"
        PAY_RESPONSE=$(curl -s -X POST "http://localhost:8080/api/v1/orders/$ORDER_UUID/pay" \
          -H "Content-Type: application/json" \
          -H "X-Session-Uuid: $TEST_SESSION_UUID" \
          -d "{\"payment_method\":\"CARD\"}")

        if [[ "$PAY_RESPONSE" == *"error"* ]]; then
          echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–ø–ª–∞—Ç–µ –∑–∞–∫–∞–∑–∞."
          echo "üîç –û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞: $PAY_RESPONSE"
          exit 1
        fi
        echo "‚úÖ –ó–∞–∫–∞–∑ —É—Å–ø–µ—à–Ω–æ –æ–ø–ª–∞—á–µ–Ω"

        echo
        echo "üìä –¢–µ—Å—Ç 6: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –ø–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã (–¥–æ–ª–∂–µ–Ω –±—ã—Ç—å PAID)"
        # –ñ–¥–µ–º –Ω–µ–±–æ–ª—å—à—É—é –ø–∞—É–∑—É –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞
        sleep 1
        ORDER_INFO_RESPONSE=$(curl -s -X GET "http://localhost:8080/api/v1/orders/$ORDER_UUID" \
          -H "X-Session-Uuid: $TEST_SESSION_UUID")

        # –ò–∑–≤–ª–µ–∫–∞–µ–º —Å—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞
        ORDER_STATUS=$(echo $ORDER_INFO_RESPONSE | grep -o '"status":"[^"]*' | cut -d'"' -f4)
        if [ -z "$ORDER_STATUS" ]; then
          ORDER_STATUS=$(echo $ORDER_INFO_RESPONSE | grep -o '"status": "[^"]*' | cut -d'"' -f4)
        fi

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Å—Ç–∞—Ç—É—Å —Å—Ç–∞–ª PAID
        if [[ "$ORDER_STATUS" != *"PAID"* ]]; then
          echo "‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Å—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞ –ø–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã. –û–∂–∏–¥–∞–ª—Å—è PAID –∏–ª–∏ ASSEMBLED, –ø–æ–ª—É—á–µ–Ω: $ORDER_STATUS"
          exit 1
        fi
        echo "‚úÖ –°—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞ –ø–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã: $ORDER_STATUS"

        # –ï—Å–ª–∏ —Å—Ç–∞—Ç—É—Å PAID, –∂–¥–µ–º —Å–±–æ—Ä–∫—É
        if [[ "$ORDER_STATUS" == *"PAID"* ]]; then
          echo "–û–∂–∏–¥–∞–µ–º —Å–±–æ—Ä–∫—É –∑–∞–∫–∞–∑–∞ (11 —Å–µ–∫—É–Ω–¥)..."
          sleep 11
          
          ORDER_INFO_RESPONSE=$(curl -s -X GET "http://localhost:8080/api/v1/orders/$ORDER_UUID" \
            -H "X-Session-Uuid: $TEST_SESSION_UUID")
          ORDER_STATUS=$(echo $ORDER_INFO_RESPONSE | grep -o '"status":"[^"]*' | cut -d'"' -f4)
          if [ -z "$ORDER_STATUS" ]; then
            ORDER_STATUS=$(echo $ORDER_INFO_RESPONSE | grep -o '"status": "[^"]*' | cut -d'"' -f4)
          fi
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Å—Ç–∞—Ç—É—Å –∏–∑–º–µ–Ω–∏–ª—Å—è –Ω–∞ ASSEMBLED
          if [[ "$ORDER_STATUS" != *"ASSEMBLED"* ]]; then
            echo "‚ùå –°—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞ –Ω–µ –∏–∑–º–µ–Ω–∏–ª—Å—è –Ω–∞ ASSEMBLED –ø–æ—Å–ª–µ –æ–∂–∏–¥–∞–Ω–∏—è. –¢–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å: $ORDER_STATUS"
            exit 1
          fi
          
          echo "‚úÖ –°—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞ –ø–æ—Å–ª–µ –æ–∂–∏–¥–∞–Ω–∏—è —Å–±–æ—Ä–∫–∏: $ORDER_STATUS (–æ–∂–∏–¥–∞–ª–∏ ASSEMBLED)"
        fi

        echo
        echo "üìù –¢–µ—Å—Ç 7: –°–æ–∑–¥–∞–Ω–∏–µ –≤—Ç–æ—Ä–æ–≥–æ –∑–∞–∫–∞–∑–∞ –¥–ª—è –æ—Ç–º–µ–Ω—ã (REST API —Å –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–µ–π)"
        ORDER2_RESPONSE=$(curl -s -X POST "http://localhost:8080/api/v1/orders" \
          -H "Content-Type: application/json" \
          -H "X-Session-Uuid: $TEST_SESSION_UUID" \
          -d "{\"user_uuid\":\"$TEST_USER_UUID\",\"part_uuids\":[\"$PART_UUID\"]}")

        if [[ -z "$ORDER2_RESPONSE" || "$ORDER2_RESPONSE" == *"error"* ]]; then
          echo "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –≤—Ç–æ—Ä–æ–π –∑–∞–∫–∞–∑."
          echo "üîç –û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞: $ORDER2_RESPONSE"
          exit 1
        fi

        # –ò–∑–≤–ª–µ–∫–∞–µ–º UUID –≤—Ç–æ—Ä–æ–≥–æ –∑–∞–∫–∞–∑–∞ —Å —É—á–µ—Ç–æ–º —Ä–∞–∑–Ω—ã—Ö —Ñ–æ—Ä–º–∞—Ç–æ–≤ JSON
        ORDER2_UUID=$(echo $ORDER2_RESPONSE | grep -o '"order_uuid":"[^"]*' | cut -d'"' -f4)
        if [ -z "$ORDER2_UUID" ]; then
          ORDER2_UUID=$(echo $ORDER2_RESPONSE | grep -o '"order_uuid": "[^"]*' | cut -d'"' -f4)
          if [ -z "$ORDER2_UUID" ]; then
            echo "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∏–∑–≤–ª–µ—á—å UUID –≤—Ç–æ—Ä–æ–≥–æ –∑–∞–∫–∞–∑–∞ –∏–∑ –æ—Ç–≤–µ—Ç–∞."
            echo "üîç –û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞: $ORDER2_RESPONSE"
            exit 1
          fi
        fi
        echo "‚úÖ –£—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω –≤—Ç–æ—Ä–æ–π –∑–∞–∫–∞–∑ —Å UUID: $ORDER2_UUID"

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –µ–≥–æ –Ω–∞—á–∞–ª—å–Ω—ã–π —Å—Ç–∞—Ç—É—Å
        ORDER2_INFO=$(curl -s -X GET "http://localhost:8080/api/v1/orders/$ORDER2_UUID" \
          -H "X-Session-Uuid: $TEST_SESSION_UUID")
        ORDER2_STATUS=$(echo $ORDER2_INFO | grep -o '"status":"[^"]*' | cut -d'"' -f4)
        if [ -z "$ORDER2_STATUS" ]; then
          ORDER2_STATUS=$(echo $ORDER2_INFO | grep -o '"status": "[^"]*' | cut -d'"' -f4)
        fi

        if [[ "$ORDER2_STATUS" != *"PENDING_PAYMENT"* ]]; then
          echo "‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –Ω–∞—á–∞–ª—å–Ω—ã–π —Å—Ç–∞—Ç—É—Å –≤—Ç–æ—Ä–æ–≥–æ –∑–∞–∫–∞–∑–∞. –û–∂–∏–¥–∞–ª—Å—è PENDING_PAYMENT, –ø–æ–ª—É—á–µ–Ω: $ORDER2_STATUS"
          exit 1
        fi
        echo "‚úÖ –ù–∞—á–∞–ª—å–Ω—ã–π —Å—Ç–∞—Ç—É—Å –≤—Ç–æ—Ä–æ–≥–æ –∑–∞–∫–∞–∑–∞: $ORDER2_STATUS"

        echo
        echo "‚ùå –¢–µ—Å—Ç 8: –û—Ç–º–µ–Ω–∞ –≤—Ç–æ—Ä–æ–≥–æ –∑–∞–∫–∞–∑–∞ (REST API —Å –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–µ–π)"
        echo "–û–∂–∏–¥–∞–µ–º 2 —Å–µ–∫—É–Ω–¥—ã –ø–µ—Ä–µ–¥ –æ—Ç–º–µ–Ω–æ–π..."
        sleep 2

        curl -s -X POST "http://localhost:8080/api/v1/orders/$ORDER2_UUID/cancel" \
          -H "X-Session-Uuid: $TEST_SESSION_UUID"

        echo "–ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –ø–æ—Å–ª–µ –æ—Ç–º–µ–Ω—ã..."

        ORDER2_INFO=$(curl -s -X GET "http://localhost:8080/api/v1/orders/$ORDER2_UUID" \
          -H "X-Session-Uuid: $TEST_SESSION_UUID")
        ORDER2_STATUS=$(echo $ORDER2_INFO | grep -o '"status":"[^"]*' | cut -d'"' -f4)
        if [ -z "$ORDER2_STATUS" ]; then
          ORDER2_STATUS=$(echo $ORDER2_INFO | grep -o '"status": "[^"]*' | cut -d'"' -f4)
        fi

        if [[ "$ORDER2_STATUS" != *"CANCELLED"* ]]; then
          echo "‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Å—Ç–∞—Ç—É—Å –æ—Ç–º–µ–Ω–µ–Ω–Ω–æ–≥–æ –∑–∞–∫–∞–∑–∞. –û–∂–∏–¥–∞–ª—Å—è CANCELLED, –ø–æ–ª—É—á–µ–Ω: $ORDER2_STATUS"
          echo "üîç –î–µ—Ç–∞–ª–∏ –∑–∞–∫–∞–∑–∞: $ORDER2_INFO"
          exit 1
        fi
          echo "‚úÖ –°—Ç–∞—Ç—É—Å –≤—Ç–æ—Ä–æ–≥–æ –∑–∞–∫–∞–∑–∞ –ø–æ—Å–ª–µ –æ—Ç–º–µ–Ω—ã: $ORDER2_STATUS"
          
          # –û—á–∏—â–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã
          rm -f /tmp/test_auth_data.sh
          
          echo
          echo "üéâ –í—Å–µ —Ç–µ—Å—Ç—ã API —Å –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–µ–π –≤—ã–ø–æ–ª–Ω–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ!"
        fi

  test-api:
    desc: "üöÄ –ü–æ–ª–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ API: –ø—Ä–æ–≤–µ—Ä–∫–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ + —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ —Ç–µ—Å—Ç—ã"
    deps: [grpcurl:install, test-iam]
    silent: true
    cmds:
      - task: test-api-auth-rejection
      - task: test-api-with-auth
      - |
        echo
        echo "üéâüéâüéâ –ü–û–õ–ù–û–ï –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï API –ó–ê–í–ï–†–®–ï–ù–û –£–°–ü–ï–®–ù–û! üéâüéâüéâ"
        echo
        echo "‚úÖ –¢–µ—Å—Ç—ã –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è –Ω–µ–∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ - –ø—Ä–æ—à–ª–∏"
        echo "‚úÖ –¢–µ—Å—Ç—ã API —Å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–µ–π - –ø—Ä–æ—à–ª–∏"  
        echo
        echo "üîê –í—Å–µ –æ—Å–Ω–æ–≤–Ω—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏ API —Ä–∞–±–æ—Ç–∞—é—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ!"

  env:install-envsubst:
    desc: "Installs envsubst into bin/"
    cmds:
      - |
        [ -f {{.ENVSUBST}} ] || {
          echo "üì¶ Installing envsubst version {{.ENVSUBST_VERSION}}..."
          GOBIN={{.BIN_DIR}} go install github.com/a8m/envsubst/cmd/envsubst@{{.ENVSUBST_VERSION}}
        }
        echo "‚úÖ envsubst installed: {{.ENVSUBST}}"

  env:generate:
    desc: "Generates .env files for all services from templates and unified config file"
    deps: [env:install-envsubst]
    cmds:
      - |
        ENV_FILE="{{.ENVDIR}}/.env"
        TEMPLATE_FILE="{{.ENVDIR}}/.env.template"
        SCRIPT="{{.ENVDIR}}/generate-env.sh"

        if [ ! -f "$ENV_FILE" ]; then
          if [ -f "$TEMPLATE_FILE" ]; then
            echo "üîÑ File $ENV_FILE not found, creating from template $TEMPLATE_FILE"
            cp "$TEMPLATE_FILE" "$ENV_FILE"
            echo "‚úÖ Created file $ENV_FILE. Review and edit variable values as needed."
          else
            echo "‚ùå Template $TEMPLATE_FILE not found!"
            exit 1
          fi
        fi

        chmod +x "$SCRIPT"
        # Pass service list as comma-separated string
        export SERVICES="{{.SERVICES}}"
        ENV_SUBST={{.ENVSUBST}} "$SCRIPT"

  test-integration:
    desc: "Runs integration tests for specified modules"
    summary: |
      Runs integration tests for modules specified via MODULES variable.
      Uses "integration" tag to identify integration tests.
    cmds:
      - |
        ERR=0
        echo "üöÄ Running integration tests (by integration tag) for modules: {{.MODULES}}"
        for mod in {{.MODULES}}; do
          if [ -d "$mod" ]; then
            echo "üß™ Checking module $mod for integration tests"
            
            # Check for files with integration tag
            HAS_TESTS=$(grep -r "//go:build integration" $mod --include="*.go" | wc -l)
            
            if [ "$HAS_TESTS" -eq 0 ]; then
              echo "‚ö†Ô∏è Module $mod does not contain integration tests (with integration tag), skipping"
              continue
            fi
            
            echo "‚ñ∂Ô∏è Running integration tests for $mod"
            go test -v -tags=integration ./$mod/... || ERR=1
          fi
        done
        exit $ERR

  e2e:test:inventory:
    desc: "Runs e2e tests for Inventory service"
    dir: inventory/tests/e2e
    cmds:
      - echo "üöÄ Running Inventory service e2e tests..."
      - cd ../../ && go mod tidy
      - go test -tags=integration -v ./...

  # ===============================
  # GATEWAY (Envoy + All Services)
  # ===============================

  gateway:up:
    desc: "üöÄ –ó–∞–ø—É—Å–∫–∞–µ—Ç –ø–æ–ª–Ω—É—é –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—É Gateway (Order + Inventory + IAM + Envoy)"
    dir: deploy/compose/gateway
    cmds:
      - echo "üèóÔ∏è –°–æ–±–∏—Ä–∞–µ–º –∏ –∑–∞–ø—É—Å–∫–∞–µ–º Gateway –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—É..."
      - docker compose up --build --detach
      - echo ""
      - echo "‚è≥ –û–∂–∏–¥–∞–µ–º –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ —Å–µ—Ä–≤–∏—Å–æ–≤..."
      - sleep 10
      - task: gateway:health

  gateway:down:
    desc: "üõë –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç Gateway –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—É"
    dir: deploy/compose/gateway
    cmds:
      - echo "üõë –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Gateway –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—É..."
      - docker compose down
      - echo "‚úÖ Gateway –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"

  gateway:restart:
    desc: "üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ—Ç Gateway –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—É"
    cmds:
      - task: gateway:down
      - task: gateway:up

  gateway:logs:
    desc: "üìù –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ª–æ–≥–∏ –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤ Gateway"
    dir: deploy/compose/gateway
    cmds:
      - docker compose logs -f

  gateway:logs:envoy:
    desc: "üìù –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ª–æ–≥–∏ Envoy"
    dir: deploy/compose/gateway
    cmds:
      - docker compose logs -f envoy

  gateway:logs:order:
    desc: "üìù –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ª–æ–≥–∏ Order Service"
    dir: deploy/compose/gateway
    cmds:
      - docker compose logs -f order-service

  gateway:logs:inventory:
    desc: "üìù –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ª–æ–≥–∏ Inventory Service"
    dir: deploy/compose/gateway
    cmds:
      - docker compose logs -f inventory-service

  gateway:logs:iam:
    desc: "üìù –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ª–æ–≥–∏ IAM Service"
    dir: deploy/compose/gateway
    cmds:
      - docker compose logs -f iam-service

  gateway:ps:
    desc: "üìä –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å—Ç–∞—Ç—É—Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ Gateway"
    dir: deploy/compose/gateway
    cmds:
      - docker compose ps

  gateway:clean:
    desc: "üßπ –û—á–∏—â–∞–µ—Ç Gateway Docker —Ä–µ—Å—É—Ä—Å—ã (–≤–∫–ª—é—á–∞—è volumes)"
    dir: deploy/compose/gateway
    cmds:
      - echo "üßπ –û—á–∏—â–∞–µ–º Gateway Docker —Ä–µ—Å—É—Ä—Å—ã..."
      - docker compose down --volumes --remove-orphans
      - echo "‚úÖ –û—á–∏—Å—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞"

  gateway:health:
    desc: "üè• –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –∑–¥–æ—Ä–æ–≤—å–µ –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤ Gateway"
    dir: deploy/compose/gateway
    cmds:
      - |
        echo "üè• –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è Gateway —Å–µ—Ä–≤–∏—Å–æ–≤..."
        echo ""
        echo "üìä Envoy Admin (ready check):"
        curl -sf http://localhost:8081/ready && echo " ‚úÖ Envoy –≥–æ—Ç–æ–≤" || echo "‚ùå Envoy –Ω–µ –≥–æ—Ç–æ–≤"
        echo ""
        echo "üîê Health check (–±–µ–∑ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏):"
        curl -sf http://localhost:8080/healthz && echo " ‚úÖ Healthz –¥–æ—Å—Ç—É–ø–µ–Ω" || echo "‚ùå Healthz –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω"
        echo ""
        echo "üìä –°—Ç–∞—Ç—É—Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤:"
        docker compose ps --format "table {{.Name}}\t{{.Status}}"

  gateway:envoy:stats:
    desc: "üìà –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É Envoy"
    cmds:
      - curl -s http://localhost:8081/stats | head -50

  gateway:envoy:stats:auth:
    desc: "üîê –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É External Authorization"
    cmds:
      - curl -s http://localhost:8081/stats | grep ext_authz

  gateway:envoy:clusters:
    desc: "üåê –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å—Ç–∞—Ç—É—Å –∫–ª–∞—Å—Ç–µ—Ä–æ–≤ Envoy"
    cmds:
      - curl -s http://localhost:8081/clusters | grep -E "^[a-z_]+::"

  proto:build:inventory-descriptor:
    desc: "üì¶ –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç proto –¥–µ—Å–∫—Ä–∏–ø—Ç–æ—Ä –¥–ª—è Inventory Service (gRPC transcoding)"
    deps: [install-buf]
    dir: shared/proto
    cmds:
      - echo "üì¶ –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º inventory_descriptor.pb..."
      - "{{.BUF}} build --path inventory --path common --as-file-descriptor-set --output ../pkg/proto/inventory/v1/inventory_descriptor.pb"
      - echo "‚úÖ –î–µ—Å–∫—Ä–∏–ø—Ç–æ—Ä —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω –≤ shared/pkg/proto/inventory/v1/inventory_descriptor.pb"

  gateway:test:public:
    desc: "üß™ –¢–µ—Å—Ç–∏—Ä—É–µ—Ç –ø—É–±–ª–∏—á–Ω—ã–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã Gateway (–±–µ–∑ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏)"
    cmds:
      - |
        echo "üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—É–±–ª–∏—á–Ω—ã—Ö —ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤..."
        echo ""

        echo "üìç GET /healthz"
        result=$(curl -s -w "\nHTTP_STATUS:%{http_code}" http://localhost:8080/healthz)
        body=$(echo "$result" | sed '$d')
        status=$(echo "$result" | tail -1 | cut -d':' -f2)
        echo "   –û—Ç–≤–µ—Ç: $body"
        echo "   HTTP: $status"
        if [ "$status" = "200" ]; then
          echo "   ‚úÖ /healthz –¥–æ—Å—Ç—É–ø–µ–Ω –±–µ–∑ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏"
        else
          echo "   ‚ùå /healthz –¥–æ–ª–∂–µ–Ω –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å 200" >&2
          exit 1
        fi
        echo ""

        echo "üìç GET /readyz"
        result=$(curl -s -w "\nHTTP_STATUS:%{http_code}" http://localhost:8080/readyz)
        body=$(echo "$result" | sed '$d')
        status=$(echo "$result" | tail -1 | cut -d':' -f2)
        echo "   –û—Ç–≤–µ—Ç: $body"
        echo "   HTTP: $status"
        if [ "$status" = "200" ]; then
          echo "   ‚úÖ /readyz –¥–æ—Å—Ç—É–ø–µ–Ω –±–µ–∑ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏"
        else
          echo "   ‚ùå /readyz –¥–æ–ª–∂–µ–Ω –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å 200" >&2
          exit 1
        fi
        echo ""

        echo "‚úÖ –í—Å–µ –ø—É–±–ª–∏—á–Ω—ã–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã —Ä–∞–±–æ—Ç–∞—é—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ!"

  gateway:test:auth:denied:
    desc: "üîê –¢–µ—Å—Ç–∏—Ä—É–µ—Ç —á—Ç–æ –∑–∞–ø—Ä–æ—Å—ã –±–µ–∑ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –æ—Ç–∫–ª–æ–Ω—è—é—Ç—Å—è Gateway"
    cmds:
      - |
        echo "üîê –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤ –±–µ–∑ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏..."
        echo ""

        echo "üìç GET /api/v1/orders (–±–µ–∑ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏)"
        result=$(curl -s -w "\nHTTP_STATUS:%{http_code}" http://localhost:8080/api/v1/orders)
        status=$(echo "$result" | tail -1 | cut -d':' -f2)
        echo "   HTTP: $status"
        if [ "$status" = "401" ] || [ "$status" = "403" ]; then
          echo "   ‚úÖ –ó–∞–ø—Ä–æ—Å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ—Ç–∫–ª–æ–Ω–µ–Ω (HTTP $status)"
        else
          echo "   ‚ùå –ó–∞–ø—Ä–æ—Å –¥–æ–ª–∂–µ–Ω –±—ã–ª –±—ã—Ç—å –æ—Ç–∫–ª–æ–Ω–µ–Ω —Å HTTP 401/403, –ø–æ–ª—É—á–µ–Ω HTTP $status" >&2
          exit 1
        fi
        echo ""

        echo "üìç POST /api/v1/parts (–±–µ–∑ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏)"
        result=$(curl -s -w "\nHTTP_STATUS:%{http_code}" -X POST http://localhost:8080/api/v1/parts \
          -H "Content-Type: application/json" \
          -d '{}')
        status=$(echo "$result" | tail -1 | cut -d':' -f2)
        echo "   HTTP: $status"
        if [ "$status" = "401" ] || [ "$status" = "403" ]; then
          echo "   ‚úÖ –ó–∞–ø—Ä–æ—Å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ—Ç–∫–ª–æ–Ω–µ–Ω (HTTP $status)"
        else
          echo "   ‚ùå –ó–∞–ø—Ä–æ—Å –¥–æ–ª–∂–µ–Ω –±—ã–ª –±—ã—Ç—å –æ—Ç–∫–ª–æ–Ω–µ–Ω —Å HTTP 401/403, –ø–æ–ª—É—á–µ–Ω HTTP $status" >&2
          exit 1
        fi
        echo ""

        echo "‚úÖ –í—Å–µ –Ω–µ–∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ—Ç–∫–ª–æ–Ω—è—é—Ç—Å—è!"

  gateway:test:iam:check:
    desc: "üîê –¢–µ—Å—Ç–∏—Ä—É–µ—Ç External Authorization API —á–µ—Ä–µ–∑ gRPC"
    deps: [grpcurl:install]
    cmds:
      - |
        echo "üîê –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ External Authorization API..."
        echo ""

        echo "üìç –¢–µ—Å—Ç —Å –≤–∞–ª–∏–¥–Ω—ã–º Session-UUID header"
        result=$({{.GRPCURL}} -plaintext -d '{
          "attributes": {
            "request": {
              "http": {
                "headers": {
                  "session-uuid": "123e4567-e89b-12d3-a456-426614174000"
                }
              }
            }
          }
        }' localhost:50053 envoy.service.auth.v3.Authorization/Check 2>&1 || true)
        echo "   –†–µ–∑—É–ª—å—Ç–∞—Ç: $result"

        if echo "$result" | grep -q '"okResponse"'; then
          echo "   ‚úÖ –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —Å Session-UUID header —É—Å–ø–µ—à–Ω–∞"
        elif echo "$result" | grep -q '"deniedResponse"'; then
          echo "   ‚ÑπÔ∏è –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –æ—Ç–∫–ª–æ–Ω–µ–Ω–∞ (–≤–æ–∑–º–æ–∂–Ω–æ —Å–µ—Å—Å–∏—è –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç)"
        else
          echo "   ‚ö†Ô∏è –ù–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç"
        fi
        echo ""

        echo "üìç –¢–µ—Å—Ç –ë–ï–ó session (–¥–æ–ª–∂–µ–Ω –æ—Ç–∫–ª–æ–Ω–∏—Ç—å)"
        result=$({{.GRPCURL}} -plaintext -d '{
          "attributes": {
            "request": {
              "http": {
                "headers": {
                  "content-type": "application/json"
                }
              }
            }
          }
        }' localhost:50053 envoy.service.auth.v3.Authorization/Check 2>&1 || true)
        echo "   –†–µ–∑—É–ª—å—Ç–∞—Ç: $result"

        if echo "$result" | grep -q '"deniedResponse"'; then
          echo "   ‚úÖ –ó–∞–ø—Ä–æ—Å –±–µ–∑ session –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ—Ç–∫–ª–æ–Ω–µ–Ω"
        else
          echo "   ‚ùå –ó–∞–ø—Ä–æ—Å –¥–æ–ª–∂–µ–Ω –±—ã–ª –±—ã—Ç—å –æ—Ç–∫–ª–æ–Ω–µ–Ω" >&2
          exit 1
        fi
        echo ""

        echo "‚úÖ –¢–µ—Å—Ç—ã External Authorization –ø—Ä–æ—à–ª–∏!"

  gateway:test:orders:
    desc: "üõí –¢–µ—Å—Ç–∏—Ä—É–µ—Ç Order Service API —á–µ—Ä–µ–∑ Envoy Gateway (HTTP‚ÜîHTTP)"
    cmds:
      - |
        echo "üõí –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ Order Service API —á–µ—Ä–µ–∑ HTTP Gateway..."
        echo ""

        SESSION_UUID="123e4567-e89b-12d3-a456-426614174000"

        echo "üìç POST /api/v1/orders (—Å–æ–∑–¥–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞)"
        create_result=$(curl -s -w "\nHTTP_STATUS:%{http_code}" -X POST http://localhost:8080/api/v1/orders \
          -H "Content-Type: application/json" \
          -H "Session-UUID: $SESSION_UUID" \
          -d '{
            "user_uuid": "550e8400-e29b-41d4-a716-446655440000",
            "part_uuids": ["123e4567-e89b-12d3-a456-426614174001"]
          }')
        body=$(echo "$create_result" | sed '$d')
        status=$(echo "$create_result" | tail -1 | cut -d':' -f2)
        echo "   –û—Ç–≤–µ—Ç: $body"
        echo "   HTTP: $status"

        # 401/403 = auth —Ä–∞–±–æ—Ç–∞–µ—Ç, –Ω–æ —Å–µ—Å—Å–∏—è –Ω–µ–≤–∞–ª–∏–¥–Ω–∞ (–æ–∂–∏–¥–∞–µ–º–æ –¥–ª—è —Ç–µ—Å—Ç–æ–≤–æ–π —Å–µ—Å—Å–∏–∏)
        # 201/200 = —É—Å–ø–µ—Ö, 400 = –æ—à–∏–±–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏, 502 = backend –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω
        if [ "$status" = "201" ] || [ "$status" = "200" ] || [ "$status" = "400" ] || [ "$status" = "401" ] || [ "$status" = "403" ] || [ "$status" = "502" ]; then
          echo "   ‚úÖ Order Service –¥–æ—Å—Ç—É–ø–µ–Ω —á–µ—Ä–µ–∑ Gateway (HTTP $status)"
        else
          echo "   ‚ùå –ù–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–π —Å—Ç–∞—Ç—É—Å –æ—Ç Order Service: HTTP $status" >&2
          exit 1
        fi
        echo ""

        echo "‚úÖ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ Order Service –∑–∞–≤–µ—Ä—à–µ–Ω–æ!"

  gateway:test:inventory:
    desc: "üì¶ –¢–µ—Å—Ç–∏—Ä—É–µ—Ç Inventory Service API —á–µ—Ä–µ–∑ Envoy Gateway (HTTP‚ÜîgRPC transcoding)"
    cmds:
      - |
        echo "üì¶ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ Inventory Service API —á–µ—Ä–µ–∑ HTTP Gateway (gRPC transcoding)..."
        echo ""

        SESSION_UUID="123e4567-e89b-12d3-a456-426614174000"

        echo "üìç POST /api/v1/parts (ListParts —á–µ—Ä–µ–∑ gRPC transcoding)"
        list_result=$(curl -s -w "\nHTTP_STATUS:%{http_code}" -X POST http://localhost:8080/api/v1/parts \
          -H "Content-Type: application/json" \
          -H "Session-UUID: $SESSION_UUID" \
          -d '{"filter": {}}')
        body=$(echo "$list_result" | sed '$d')
        status=$(echo "$list_result" | tail -1 | cut -d':' -f2)
        echo "   –û—Ç–≤–µ—Ç: $body"
        echo "   HTTP: $status"

        # 401/403 = auth —Ä–∞–±–æ—Ç–∞–µ—Ç, –Ω–æ —Å–µ—Å—Å–∏—è –Ω–µ–≤–∞–ª–∏–¥–Ω–∞
        if [ "$status" = "200" ]; then
          echo "   ‚úÖ gRPC transcoding —Ä–∞–±–æ—Ç–∞–µ—Ç (ListParts)"
        elif [ "$status" = "401" ] || [ "$status" = "403" ]; then
          echo "   ‚úÖ Gateway —Ä–∞–±–æ—Ç–∞–µ—Ç, auth –æ—Ç–∫–ª–æ–Ω–∏–ª –Ω–µ–≤–∞–ª–∏–¥–Ω—É—é —Å–µ—Å—Å–∏—é (HTTP $status)"
        elif [ "$status" = "502" ] || [ "$status" = "503" ]; then
          echo "   ‚ö†Ô∏è Inventory Service –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω"
        else
          echo "   ‚ö†Ô∏è –°—Ç–∞—Ç—É—Å: HTTP $status"
        fi
        echo ""

        echo "üìç GET /api/v1/parts/{uuid} (GetPart —á–µ—Ä–µ–∑ gRPC transcoding)"
        get_result=$(curl -s -w "\nHTTP_STATUS:%{http_code}" http://localhost:8080/api/v1/parts/123e4567-e89b-12d3-a456-426614174001 \
          -H "Session-UUID: $SESSION_UUID")
        body=$(echo "$get_result" | sed '$d')
        status=$(echo "$get_result" | tail -1 | cut -d':' -f2)
        echo "   –û—Ç–≤–µ—Ç: $body"
        echo "   HTTP: $status"

        if [ "$status" = "200" ] || [ "$status" = "404" ]; then
          echo "   ‚úÖ gRPC transcoding —Ä–∞–±–æ—Ç–∞–µ—Ç (GetPart)"
        elif [ "$status" = "401" ] || [ "$status" = "403" ]; then
          echo "   ‚úÖ Gateway —Ä–∞–±–æ—Ç–∞–µ—Ç, auth –æ—Ç–∫–ª–æ–Ω–∏–ª –Ω–µ–≤–∞–ª–∏–¥–Ω—É—é —Å–µ—Å—Å–∏—é (HTTP $status)"
        else
          echo "   ‚ö†Ô∏è –°—Ç–∞—Ç—É—Å: HTTP $status"
        fi
        echo ""

        echo "‚úÖ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ Inventory Service –∑–∞–≤–µ—Ä—à–µ–Ω–æ!"

  gateway:test:grpc:inventory:
    desc: "üì¶ –¢–µ—Å—Ç–∏—Ä—É–µ—Ç Inventory gRPC Service –Ω–∞–ø—Ä—è–º—É—é"
    deps: [grpcurl:install]
    cmds:
      - |
        echo "üì¶ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ Inventory gRPC Service..."
        echo ""

        echo "üìç ListParts"
        result=$({{.GRPCURL}} -plaintext -d '{"filter": {}}' localhost:50051 inventory.v1.InventoryService/ListParts 2>&1 || true)
        echo "   –†–µ–∑—É–ª—å—Ç–∞—Ç: $result"
        echo ""

        echo "üìç GetPart"
        result=$({{.GRPCURL}} -plaintext -d '{"uuid": "123e4567-e89b-12d3-a456-426614174001"}' localhost:50051 inventory.v1.InventoryService/GetPart 2>&1 || true)
        echo "   –†–µ–∑—É–ª—å—Ç–∞—Ç: $result"
        echo ""

        echo "‚úÖ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ Inventory gRPC –∑–∞–≤–µ—Ä—à–µ–Ω–æ!"

  gateway:test:all:
    desc: "üß™ –ó–∞–ø—É—Å–∫–∞–µ—Ç –≤—Å–µ —Ç–µ—Å—Ç—ã Gateway"
    cmds:
      - echo "üß™ –ó–∞–ø—É—Å–∫–∞–µ–º –ø–æ–ª–Ω—ã–π –Ω–∞–±–æ—Ä —Ç–µ—Å—Ç–æ–≤ Gateway..."
      - echo ""
      - task: gateway:test:public
      - echo ""
      - task: gateway:test:auth:denied
      - echo ""
      - task: gateway:test:iam:check
      - echo ""
      - task: gateway:test:orders
      - echo ""
      - task: gateway:test:inventory
      - echo ""
      - echo "üéâ –í—Å–µ —Ç–µ—Å—Ç—ã Gateway –∑–∞–≤–µ—Ä—à–µ–Ω—ã!"
